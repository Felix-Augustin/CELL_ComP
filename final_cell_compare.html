<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>细胞结构3D可视化平台 - 最终完整版 v5.0</title>
    
    <!-- Three.js 核心库 -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    
    <!-- OBJ和MTL加载器 - 用于加载原核细胞模型 -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/MTLLoader.js"></script>
    
    <!-- BioDigital API - 用于真核细胞专业模型 -->
    <script src="https://developer.biodigital.com/builds/api/human-api-3.0.0.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #09375C, #3DA4E6, #95D4F3);
        }
        
        /* 开场视频容器 */
        #video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #09375C, #2B313F);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        #intro-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #platform-title {
            position: absolute;
            color: #F9F2E0;
            text-align: center;
            font-size: 3rem;
            font-weight: bold;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transform: translateY(30px);
            transition: all 1.5s ease;
            z-index: 1001;
        }
        
        #platform-title.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        #enter-button {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 20px 40px;
            font-size: 18px;
            background: rgba(249, 242, 224, 0.15);
            color: #F9F2E0;
            border: 2px solid rgba(249, 242, 224, 0.3);
            border-radius: 15px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
            z-index: 1001;
        }
        
        #enter-button.show {
            opacity: 1;
        }
        
        #enter-button:hover {
            background: rgba(249, 242, 224, 0.25);
            transform: translateX(-50%) translateY(-3px);
            box-shadow: 0 8px 25px rgba(249, 242, 224, 0.2);
        }
        
        /* 主应用容器 */
        #main-container {
            display: none;
            width: 100vw;
            height: 100vh;
            flex-direction: row;
        }
        
        /* 控制面板 */
        #control-panel {
            width: 300px;
            padding: 20px;
            background: linear-gradient(135deg, #F9F2E0, #F7ECE7);
            box-shadow: 0 0 20px rgba(9, 55, 92, 0.2);
            overflow-y: auto;
            border-right: 2px solid rgba(9, 55, 92, 0.1);
        }
        
        /* 展示区域容器 - 分为左右两块 */
        #display-container {
            flex: 1;
            display: flex;
            flex-direction: row;
            background: #f0f0f0;
        }
        
        /* 原核细胞展示区域（左侧） */
        #prokaryotic-container {
            flex: 1;
            position: relative;
            background: linear-gradient(135deg, #95D4F3, #3DA4E6, #09375C);
            border-right: 2px solid rgba(9, 55, 92, 0.3);
        }
        
        /* 真核细胞展示区域（右侧） */
        #eukaryotic-container {
            flex: 1;
            position: relative;
            background: linear-gradient(135deg, #C6E6E8, #95D4F3, #3DA4E6);
        }
        
        /* 区域标题 */
        .area-title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(9, 55, 92, 0.9);
            color: #F9F2E0;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            z-index: 100;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(249, 242, 224, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* BioDigital嵌入式容器 - 现在填满右侧区域 */
        #biodigital-eukaryotic-cell {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            overflow: hidden;
            background: transparent;
            z-index: 5;
        }
        
        #biodigital-cell-widget {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
        }
        
        .biodigital-overlay {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(9, 55, 92, 0.9);
            color: #F9F2E0;
            padding: 10px 25px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(249, 242, 224, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* 信息面板样式 */
        .section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            border-left: 4px solid #1660AB;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .info-panel {
            background: rgba(9, 55, 92, 0.1);
            border: 1px solid rgba(249, 242, 224, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .info-panel p {
            margin: 5px 0;
            color: #2B313F;
            font-size: 14px;
            line-height: 1.4;
        }
        
        /* 高亮按钮样式 */
        .highlight-btn {
            display: inline-block;
            margin: 5px 5px 5px 0;
            padding: 8px 12px;
            background: linear-gradient(135deg, #1660AB, #3DA4E6);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .highlight-btn:hover {
            background: linear-gradient(135deg, #3DA4E6, #95D4F3);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .highlight-btn.active {
            background: linear-gradient(135deg, #A61B29, #FF4444);
        }
        
        /* 控制按钮组 */
        .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .control-btn {
            flex: 1;
            min-width: 80px;
            padding: 10px;
            background: linear-gradient(135deg, #1660AB, #3DA4E6);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            background: linear-gradient(135deg, #3DA4E6, #95D4F3);
            transform: translateY(-1px);
        }
        
        /* 切换开关样式 */
        .toggle-switch {
            display: inline-flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .toggle-switch input[type="checkbox"] {
            display: none;
        }
        
        .toggle-slider {
            width: 50px;
            height: 24px;
            background: #ccc;
            border-radius: 12px;
            position: relative;
            cursor: pointer;
            transition: 0.3s;
            margin-right: 10px;
        }
        
        .toggle-slider:before {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: 0.3s;
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background: #1660AB;
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* 加载状态指示器 */
        .loading-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(9, 55, 92, 0.9);
            color: #F9F2E0;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 100;
            backdrop-filter: blur(10px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .loading-indicator.show {
            opacity: 1;
        }
        
        /* 标题样式 */
        h1 { 
            color: #A61B29; 
            border-bottom: 3px solid #A61B29; 
            padding-bottom: 10px; 
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        h2 { 
            color: #1660AB; 
            border-bottom: 2px solid #1660AB; 
            padding-bottom: 8px; 
            margin-bottom: 15px;
            font-size: 1.4rem;
        }
        
        h3 { 
            color: #2B313F; 
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        /* 状态指示器 */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-loading { background-color: #FFA500; }
        .status-success { background-color: #4CAF50; }
        .status-error { background-color: #F44336; }
        
        /* 响应式设计 */
        @media (max-width: 1200px) {
            #control-panel {
                width: 280px;
            }
            
            #biodigital-eukaryotic-cell {
                width: 500px;
                height: 500px;
                right: 60px;
                top: 100px;
            }
        }
        
        @media (max-width: 900px) {
            #control-panel {
                width: 250px;
                padding: 15px;
            }
            
            #biodigital-eukaryotic-cell {
                width: 400px;
                height: 400px;
                right: 40px;
                top: 80px;
            }
            
            h1 { font-size: 1.5rem; }
            h2 { font-size: 1.2rem; }
            h3 { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <!-- 开场视频 -->
    <div id="video-container">
        <video id="intro-video" muted autoplay loop>
            <source src="animation.mp4" type="video/mp4">
            您的浏览器不支持视频播放。
        </video>
        <div id="platform-title">细胞结构3D可视化平台</div>
        <button id="enter-button">🔬 进入3D世界</button>
    </div>
    
    <!-- 主应用 -->
    <div id="main-container">
        <!-- 控制面板 -->
        <div id="control-panel">
            <h1>🧬 细胞结构对比平台</h1>
            
            <div class="section">
                <h2>📊 模型状态</h2>
                <div class="info-panel">
                    <p><span class="status-indicator status-loading" id="prokaryotic-status"></span><strong>原核细胞:</strong> <span id="prokaryotic-text">准备加载...</span></p>
                    <p><span class="status-indicator status-loading" id="eukaryotic-status"></span><strong>真核细胞:</strong> <span id="eukaryotic-text">准备加载...</span></p>
                </div>
            </div>
            
            <div class="section">
                <h2>🎯 特性对比</h2>
                <div class="info-panel">
                    <p><strong>左侧：</strong>原核细胞 (专业OBJ模型)</p>
                    <p><strong>右侧：</strong>真核细胞 (BioDigital 3D模型)</p>
                    <p><strong>操作：</strong>鼠标拖拽旋转，滚轮缩放</p>
                </div>
                
                <div class="control-group">
                    <button class="control-btn" onclick="resetCamera()">重置视角</button>
                    <button class="control-btn" onclick="toggleFullscreen()">全屏模式</button>
                </div>
            </div>
            
            <div class="section">
                <h3>🦠 原核细胞特征</h3>
                <div class="info-panel">
                    <p>🧬 使用 cell_model1/cell_model1 专业OBJ模型</p>
                    <p>📚 包含细胞膜、细胞壁、拟核等完整结构</p>
                    <p>🎨 支持高质量纹理贴图和材质</p>
                    <p>🔄 智能备用机制确保显示</p>
                    <p>⚡ 实时光照和阴影效果</p>
                </div>
                
                <div class="info-panel">
                    <h4>🔬 原核细胞结构高亮</h4>
                    <button class="highlight-btn" onclick="highlightPart('prokaryotic', 'membrane')">细胞膜</button>
                    <button class="highlight-btn" onclick="highlightPart('prokaryotic', 'cytoplasm')">细胞质</button>
                    <button class="highlight-btn" onclick="highlightPart('prokaryotic', 'nucleoid')">拟核</button>
                    <button class="highlight-btn" onclick="highlightPart('prokaryotic', 'ribosomes')">核糖体</button>
                    <button class="highlight-btn" onclick="clearHighlight()">清除高亮</button>
                </div>
                
                <div class="toggle-switch">
                    <input type="checkbox" id="prokaryotic-animation" onchange="toggleAnimation('prokaryotic')">
                    <label for="prokaryotic-animation" class="toggle-slider"></label>
                    <span>启用动画效果</span>
                </div>
            </div>
            
            <div class="section">
                <h3>🔬 真核细胞特征</h3>
                <div class="info-panel">
                    <p>🌟 BioDigital专业医学级3D模型</p>
                    <p>🎯 使用Viewer API嵌入式显示</p>
                    <p>✨ 支持基本的视角控制和交互</p>
                    <p>🔄 多模型智能切换机制</p>
                    <p>� 医学教育标准质量</p>
                    <p>� 完全响应式设计</p>
                </div>
                
                <div class="info-panel">
                    <h4>🧬 真核细胞结构聚焦</h4>
                    <button class="highlight-btn" onclick="highlightEukaryoticPart('nucleus')">细胞核</button>
                    <button class="highlight-btn" onclick="highlightEukaryoticPart('mitochondria')">线粒体</button>
                    <button class="highlight-btn" onclick="highlightEukaryoticPart('er')">内质网</button>
                    <button class="highlight-btn" onclick="highlightEukaryoticPart('golgi')">高尔基体</button>
                    <button class="highlight-btn" onclick="clearEukaryoticHighlight()">重置视图</button>
                </div>
                
                <div class="control-group">
                    <button class="control-btn" onclick="testBioDigitalAPI()">测试API</button>
                    <button class="control-btn" onclick="resetBioDigitalView()">重置视图</button>
                    <button class="control-btn" onclick="showModelInfo()">查看信息</button>
                </div>
            </div>
            
            <div class="section">
                <h3>🎮 交互指南</h3>
                <div class="info-panel">
                    <p><strong>🖱️ 鼠标左键:</strong> 拖拽旋转视角</p>
                    <p><strong>🔄 鼠标滚轮:</strong> 缩放视图</p>
                    <p><strong>🖱️ 鼠标右键:</strong> 平移场景</p>
                    <p><strong>📱 触控设备:</strong> 单指旋转，双指缩放</p>
                    <p><strong>⌨️ R键:</strong> 重置视角</p>
                    <p><strong>⌨️ F键:</strong> 切换全屏</p>
                </div>
            </div>
            
            <div class="section">
                <h3>ℹ️ 系统信息</h3>
                <div class="info-panel">
                    <p><strong>版本:</strong> v5.0 最终完整版</p>
                    <p><strong>渲染引擎:</strong> Three.js</p>
                    <p><strong>模型格式:</strong> OBJ/MTL + BioDigital</p>
                    <p><strong>构建时间:</strong> <span id="build-time"></span></p>
                </div>
            </div>
        </div>
        
        <!-- 展示区域 -->
        <div id="display-container">
            <!-- 原核细胞展示区域（左侧） -->
            <div id="prokaryotic-container">
                <div class="area-title">🦠 原核细胞 (OBJ模型)</div>
                <div class="loading-indicator" id="prokaryotic-loading">
                    正在加载原核细胞模型...
                </div>
            </div>
            
            <!-- 真核细胞展示区域（右侧） -->
            <div id="eukaryotic-container">
                <div class="area-title">🔬 真核细胞 (BioDigital)</div>
                <div class="loading-indicator" id="eukaryotic-loading">
                    正在加载真核细胞模型...
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('🚀 细胞结构3D可视化平台 v5.0 最终完整版启动');
        console.log('📅 构建时间:', new Date().toISOString());
        
        // 全局变量
        let scene, camera, renderer, controls;
        let biodigitalLoaded = false;
        let prokaryoticLoaded = false;
        
        // BioDigital API配置 (仅用于Viewer API)
        const BIODIGITAL_API_KEY = '0e068cfbbba1de0aef62cb0f88efc977de83ff6f';
        
        // DOM元素
        const videoContainer = document.getElementById('video-container');
        const introVideo = document.getElementById('intro-video');
        const platformTitle = document.getElementById('platform-title');
        const enterButton = document.getElementById('enter-button');
        const mainContainer = document.getElementById('main-container');
        
        // 状态指示器
        const prokaryoticStatus = document.getElementById('prokaryotic-status');
        const prokaryoticText = document.getElementById('prokaryotic-text');
        const eukaryoticStatus = document.getElementById('eukaryotic-status');
        const eukaryoticText = document.getElementById('eukaryotic-text');
        
        // 加载指示器
        const prokaryoticLoading = document.getElementById('prokaryotic-loading');
        const eukaryoticLoading = document.getElementById('eukaryotic-loading');
        
        // 更新状态指示器
        function updateStatus(type, status, text) {
            const statusEl = type === 'prokaryotic' ? prokaryoticStatus : eukaryoticStatus;
            const textEl = type === 'prokaryotic' ? prokaryoticText : eukaryoticText;
            
            statusEl.className = `status-indicator status-${status}`;
            textEl.textContent = text;
        }
        
        // 显示加载指示器
        function showLoading(text) {
            if (prokaryoticLoading) {
                prokaryoticLoading.textContent = text;
                prokaryoticLoading.classList.add('show');
            }
        }
        
        // 隐藏加载指示器
        function hideLoading() {
            if (prokaryoticLoading) {
                prokaryoticLoading.classList.remove('show');
            }
        }
        
        // 显示真核细胞加载指示器
        function showEukaryoticLoading(text) {
            if (eukaryoticLoading) {
                eukaryoticLoading.textContent = text;
                eukaryoticLoading.classList.add('show');
            }
        }
        
        // 隐藏真核细胞加载指示器
        function hideEukaryoticLoading() {
            if (eukaryoticLoading) {
                eukaryoticLoading.classList.remove('show');
            }
        }
        
        // 开场视频处理
        function initVideoIntro() {
            console.log('🎬 初始化开场视频');
            
            // 视频加载成功
            introVideo.addEventListener('loadeddata', function() {
                console.log('✅ 视频加载成功');
                setTimeout(() => {
                    platformTitle.classList.add('show');
                    setTimeout(() => {
                        enterButton.classList.add('show');
                    }, 1000);
                }, 2000);
            });
            
            // 视频加载失败
            introVideo.addEventListener('error', function() {
                console.log('⚠️ 视频加载失败，直接显示进入按钮');
                setTimeout(() => {
                    platformTitle.classList.add('show');
                    enterButton.classList.add('show');
                }, 1000);
            });
            
            // 超时保护机制
            setTimeout(() => {
                if (!enterButton.classList.contains('show')) {
                    console.log('⏰ 超时保护：强制显示进入按钮');
                    platformTitle.classList.add('show');
                    enterButton.classList.add('show');
                }
            }, 5000);
        }
        
        // 进入主界面
        function enterMainApp() {
            console.log('🎯 进入主应用界面');
            videoContainer.style.opacity = '0';
            setTimeout(() => {
                videoContainer.style.display = 'none';
                mainContainer.style.display = 'flex';
                init3DViewer();
            }, 500);
        }
        
        // 初始化3D场景
        function init3DViewer() {
            console.log('🎮 初始化3D场景');
            showLoading('正在初始化3D引擎...');
            
            const container = document.getElementById('prokaryotic-container');
            
            try {
                // 场景设置
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x95D4F3);
                scene.fog = new THREE.Fog(0x95D4F3, 50, 200);
                
                // 相机设置
                camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                camera.position.set(0, 15, 35);
                
                // 渲染器设置
                renderer = new THREE.WebGLRenderer({ 
                    antialias: true,
                    alpha: true
                });
                renderer.setSize(container.clientWidth, container.clientHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                container.appendChild(renderer.domElement);
                
                // 控制器设置
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.enableZoom = true;
                controls.enableRotate = true;
                controls.enablePan = true;
                controls.autoRotate = false; // 禁用自动旋转
                controls.maxDistance = 100;
                controls.minDistance = 10;
                
                // 光源设置
                setupLighting();
                
                // 创建模型
                createProkaryoticCell();
                createBioDigitalEukaryoticCell();
                
                // 开始动画循环
                animate();
                
                console.log('✅ 3D场景初始化完成');
                hideLoading();
                
            } catch (error) {
                console.error('❌ 3D场景初始化失败:', error);
                showLoading('3D场景初始化失败，请刷新页面重试');
            }
        }
        
        // 设置光源
        function setupLighting() {
            // 环境光
            const ambientLight = new THREE.AmbientLight(0xF9F2E0, 0.6);
            scene.add(ambientLight);
            
            // 主光源
            const directionalLight = new THREE.DirectionalLight(0x3DA4E6, 1.0);
            directionalLight.position.set(15, 20, 10);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
            
            // 补充光源
            const pointLight = new THREE.PointLight(0xffffff, 0.5, 100);
            pointLight.position.set(-10, 10, 10);
            scene.add(pointLight);
        }
        
        // 创建原核细胞（OBJ模型）
        function createProkaryoticCell() {
            console.log('🧬 开始加载原核细胞OBJ模型');
            updateStatus('prokaryotic', 'loading', '正在加载OBJ模型...');
            
            // 创建加载占位符
            const loadingGroup = new THREE.Group();
            const loadingGeometry = new THREE.SphereGeometry(5, 16, 16);
            const loadingMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x4ECDC4, 
                transparent: true, 
                opacity: 0.5,
                wireframe: true
            });
            const loadingMesh = new THREE.Mesh(loadingGeometry, loadingMaterial);
            loadingGroup.add(loadingMesh);
            loadingGroup.position.set(-15, 0, 0);
            scene.add(loadingGroup);
            
            // 创建加载标签
            const loadingLabel = createTextLabel('加载中...', new THREE.Vector3(-15, 12, 0));
            scene.add(loadingLabel);
            
            // 尝试加载MTL和OBJ
            loadProkaryoticModel(loadingGroup, loadingLabel);
        }
        
        // 加载原核细胞模型
        function loadProkaryoticModel(loadingGroup, loadingLabel) {
            const mtlLoader = new THREE.MTLLoader();
            mtlLoader.setPath('./cell_model1/cell_model1/');  // 修正路径：添加嵌套的cell_model1文件夹
            
            // 首先尝试增强版MTL
            mtlLoader.load('model_enhanced.mtl', 
                function(materials) {
                    console.log('✅ 增强版MTL加载成功');
                    updateStatus('prokaryotic', 'loading', '加载OBJ模型...');
                    materials.preload();
                    loadOBJWithMaterials(materials, loadingGroup, loadingLabel);
                },
                function(progress) {
                    const percent = Math.round((progress.loaded / progress.total) * 100);
                    updateStatus('prokaryotic', 'loading', `加载材质 ${percent}%`);
                },
                function(error) {
                    console.log('⚠️ 增强版MTL失败，尝试原始MTL');
                    // 尝试原始MTL
                    mtlLoader.load('model.mtl',
                        function(materials) {
                            console.log('✅ 原始MTL加载成功');
                            materials.preload();
                            loadOBJWithMaterials(materials, loadingGroup, loadingLabel);
                        },
                        undefined,
                        function(error) {
                            console.log('⚠️ 所有MTL失败，只加载OBJ');
                            loadOBJWithoutMTL(loadingGroup, loadingLabel);
                        }
                    );
                }
            );
        }
        
        // 使用材质加载OBJ
        function loadOBJWithMaterials(materials, loadingGroup, loadingLabel) {
            const objLoader = new THREE.OBJLoader();
            objLoader.setMaterials(materials);
            objLoader.setPath('./cell_model1/cell_model1/');  // 修正路径：添加嵌套的cell_model1文件夹
            
            objLoader.load('model.obj', 
                function(object) {
                    console.log('✅ OBJ模型加载成功（带材质）');
                    updateStatus('prokaryotic', 'success', '专业OBJ模型');
                    processLoadedModel(object, loadingGroup, loadingLabel, '原核细胞 (专业模型)');
                    prokaryoticLoaded = true;
                },
                function(progress) {
                    const percent = Math.round((progress.loaded / progress.total) * 100);
                    updateStatus('prokaryotic', 'loading', `加载模型 ${percent}%`);
                },
                function(error) {
                    console.error('❌ OBJ模型加载失败:', error);
                    updateStatus('prokaryotic', 'error', '加载失败，使用备用模型');
                    createBackupProkaryoticCell(loadingGroup, loadingLabel);
                }
            );
        }
        
        // 只加载OBJ（无材质）
        function loadOBJWithoutMTL(loadingGroup, loadingLabel) {
            console.log('🔄 加载OBJ模型（无材质）');
            updateStatus('prokaryotic', 'loading', '加载OBJ（无材质）...');
            
            const objLoader = new THREE.OBJLoader();
            objLoader.setPath('./cell_model1/cell_model1/');  // 修正路径：添加嵌套的cell_model1文件夹
            
            objLoader.load('model.obj',
                function(object) {
                    console.log('✅ OBJ模型加载成功（无材质）');
                    
                    // 应用默认材质
                    object.traverse(function(child) {
                        if (child.isMesh) {
                            child.material = new THREE.MeshLambertMaterial({ 
                                color: 0x4ECDC4,
                                transparent: true,
                                opacity: 0.8
                            });
                        }
                    });
                    
                    updateStatus('prokaryotic', 'success', 'OBJ模型（默认材质）');
                    processLoadedModel(object, loadingGroup, loadingLabel, '原核细胞 (OBJ)');
                    prokaryoticLoaded = true;
                },
                function(progress) {
                    const percent = Math.round((progress.loaded / progress.total) * 100);
                    updateStatus('prokaryotic', 'loading', `加载模型 ${percent}%`);
                },
                function(error) {
                    console.error('❌ OBJ模型完全加载失败:', error);
                    updateStatus('prokaryotic', 'error', '加载失败，使用备用模型');
                    createBackupProkaryoticCell(loadingGroup, loadingLabel);
                }
            );
        }
        
        // 处理加载完成的模型
        function processLoadedModel(object, loadingGroup, loadingLabel, labelText) {
            // 移除占位符
            scene.remove(loadingGroup);
            scene.remove(loadingLabel);
            
            // 配置模型位置
            object.position.set(-15, 0, 0);
            
            // 计算和调整模型大小
            const box = new THREE.Box3().setFromObject(object);
            const size = box.getSize(new THREE.Vector3());
            const maxSize = Math.max(size.x, size.y, size.z);
            
            if (maxSize > 0) {
                const scale = 12 / maxSize;
                object.scale.setScalar(scale);
                
                // 居中模型
                const center = box.getCenter(new THREE.Vector3());
                object.position.set(-15, -center.y * scale, 0);
            }
            
            // 启用阴影
            object.traverse(function(child) {
                if (child.isMesh) {
                    child.castShadow = true;
                    child.receiveShadow = true;
                }
            });
            
            // 添加专用光源
            const modelLight = new THREE.PointLight(0xffffff, 0.8, 60);
            modelLight.position.set(-15, 15, 15);
            modelLight.castShadow = true;
            scene.add(modelLight);
            
            // 添加到场景
            scene.add(object);
            
            // 添加标签
            const label = createTextLabel(labelText, new THREE.Vector3(-15, 15, 0));
            scene.add(label);
            
            console.log('🎯 原核细胞模型集成完成:', labelText);
        }
        
        // 备用Three.js原核细胞
        function createBackupProkaryoticCell(loadingGroup, loadingLabel) {
            console.log('🔄 创建备用Three.js原核细胞');
            updateStatus('prokaryotic', 'error', 'Three.js备用模型');
            
            // 移除占位符
            scene.remove(loadingGroup);
            scene.remove(loadingLabel);
            
            const prokaryoticGroup = new THREE.Group();
            
            // 细胞膜
            const cellGeometry = new THREE.SphereGeometry(8, 32, 32);
            const cellMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x4ECDC4, 
                transparent: true, 
                opacity: 0.4 
            });
            const cellMembrane = new THREE.Mesh(cellGeometry, cellMaterial);
            cellMembrane.castShadow = true;
            prokaryoticGroup.add(cellMembrane);
            
            // 细胞质
            const cytoplasmGeometry = new THREE.SphereGeometry(7.5, 32, 32);
            const cytoplasmMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x95D4F3, 
                transparent: true, 
                opacity: 0.2 
            });
            const cytoplasm = new THREE.Mesh(cytoplasmGeometry, cytoplasmMaterial);
            prokaryoticGroup.add(cytoplasm);
            
            // 拟核
            const nucleoidGeometry = new THREE.SphereGeometry(3, 16, 16);
            const nucleoidMaterial = new THREE.MeshLambertMaterial({ color: 0x1660AB });
            const nucleoid = new THREE.Mesh(nucleoidGeometry, nucleoidMaterial);
            nucleoid.castShadow = true;
            prokaryoticGroup.add(nucleoid);
            
            // 核糖体
            for (let i = 0; i < 20; i++) {
                const ribosomeGeometry = new THREE.SphereGeometry(0.3, 8, 8);
                const ribosomeMaterial = new THREE.MeshLambertMaterial({ color: 0xA61B29 });
                const ribosome = new THREE.Mesh(ribosomeGeometry, ribosomeMaterial);
                
                const angle = (i / 20) * Math.PI * 2;
                const radius = 4 + Math.random() * 3;
                ribosome.position.set(
                    Math.cos(angle) * radius,
                    (Math.random() - 0.5) * 6,
                    Math.sin(angle) * radius
                );
                ribosome.castShadow = true;
                prokaryoticGroup.add(ribosome);
            }
            
            prokaryoticGroup.position.set(-15, 0, 0);
            scene.add(prokaryoticGroup);
            
            // 添加标签
            const label = createTextLabel('原核细胞 (备用)', new THREE.Vector3(-15, 15, 0));
            scene.add(label);
            
            prokaryoticLoaded = true;
        }
        
        // 创建BioDigital真核细胞
        function createBioDigitalEukaryoticCell() {
            console.log('🔬 初始化BioDigital真核细胞');
            updateStatus('eukaryotic', 'loading', '初始化BioDigital...');
            showEukaryoticLoading('正在加载BioDigital真核细胞...');
            
            const container = document.getElementById('eukaryotic-container');
            
            // 创建BioDigital容器
            const biodigitalContainer = document.createElement('div');
            biodigitalContainer.id = 'biodigital-eukaryotic-cell';
            
            // 添加标题覆盖层
            const overlay = document.createElement('div');
            overlay.className = 'biodigital-overlay';
            overlay.textContent = '🔬 真核细胞 (BioDigital)';
            biodigitalContainer.appendChild(overlay);
            
            // 直接使用iframe加载BioDigital模型
            loadBioDigitalModel(biodigitalContainer, container);
        }
        
        // 加载BioDigital模型
        function loadBioDigitalModel(biodigitalContainer, container) {
            // 尝试多个细胞相关的模型ID
            const cellModelIds = [
                'production/maleAdult/cell',
                'production/femaleAdult/cell', 
                'production/maleAdult/cardiovascular_system',
                'production/maleAdult/respiratory_system',
                'maleAdult',
                'femaleAdult'
            ];
            
            let currentModelIndex = 0;
            
            function tryLoadModel() {
                const modelId = cellModelIds[currentModelIndex];
                console.log(`🧪 尝试BioDigital模型: ${modelId}`);
                updateStatus('eukaryotic', 'loading', `尝试模型 ${currentModelIndex + 1}/${cellModelIds.length}`);
                
                // 清理之前的iframe
                const existingIframe = biodigitalContainer.querySelector('iframe');
                if (existingIframe) {
                    existingIframe.remove();
                }
                
                // 创建新的iframe
                const iframe = document.createElement('iframe');
                iframe.id = 'biodigital-cell-widget';
                iframe.src = `https://human.biodigital.com/widget/?m=${modelId}&dk=${BIODIGITAL_API_KEY}&ui-info=false&ui-fullscreen=false&ui-help=false&ui-layers=false&ui-search=false&ui-menu=false&ui-tools=false&background=000000&initial_load=false`;
                iframe.style.display = 'none';
                
                biodigitalContainer.appendChild(iframe);
                container.appendChild(biodigitalContainer);
                
                // 等待HumanAPI加载
                waitForHumanAPI(iframe, tryNextModel);
            }
            
            function tryNextModel() {
                currentModelIndex++;
                if (currentModelIndex < cellModelIds.length) {
                    setTimeout(tryLoadModel, 1000); // 等待1秒后尝试下一个
                } else {
                    console.log('⚠️ 所有BioDigital模型加载失败，使用备用Three.js模型');
                    updateStatus('eukaryotic', 'error', 'BioDigital失败，使用备用');
                    showThreeJSEukaryoticCell();
                }
            }
            
            // 开始尝试加载
            tryLoadModel();
        }
        
        // 等待HumanAPI加载
        function waitForHumanAPI(iframe, fallbackCallback) {
            function checkAPI() {
                if (typeof HumanAPI !== 'undefined') {
                    console.log('✅ HumanAPI可用');
                    
                    iframe.onload = function() {
                        try {
                            window.humanAPI = new HumanAPI("biodigital-cell-widget");
                            console.log('✅ BioDigital初始化成功');
                            
                            iframe.style.display = 'block';
                            biodigitalLoaded = true;
                            updateStatus('eukaryotic', 'success', 'BioDigital专业模型');
                            hideEukaryoticLoading();
                            
                            // 配置模型
                            setTimeout(() => {
                                try {
                                    if (window.humanAPI) {
                                        window.humanAPI.send("timeline.pause");
                                        window.humanAPI.send("camera.set", {
                                            position: { x: 0, y: 0, z: -100 },
                                            target: { x: 0, y: 0, z: 0 },
                                            animate: true
                                        });
                                    }
                                } catch (e) {
                                    console.log('⚠️ BioDigital配置失败（模型仍可用）');
                                }
                            }, 2000);
                            
                        } catch (error) {
                            console.error('❌ BioDigital初始化失败:', error);
                            fallbackCallback();
                        }
                    };
                    
                    iframe.onerror = fallbackCallback;
                    
                } else {
                    setTimeout(checkAPI, 500);
                }
            }
            
            checkAPI();
            
            // 超时保护
            setTimeout(() => {
                if (!biodigitalLoaded) {
                    console.log('⏰ BioDigital加载超时');
                    fallbackCallback();
                }
            }, 10000);
        }
        
        // Three.js备用真核细胞
        function showThreeJSEukaryoticCell() {
            console.log('🔄 创建Three.js备用真核细胞');
            updateStatus('eukaryotic', 'error', 'Three.js备用模型');
            hideEukaryoticLoading();
            
            // 隐藏BioDigital容器
            const biodigitalContainer = document.getElementById('biodigital-eukaryotic-cell');
            if (biodigitalContainer) {
                biodigitalContainer.style.display = 'none';
            }
            
            const eukaryoticGroup = new THREE.Group();
            
            // 细胞膜
            const cellGeometry = new THREE.SphereGeometry(10, 32, 32);
            const cellMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x95D4F3, 
                transparent: true, 
                opacity: 0.3 
            });
            const cellMembrane = new THREE.Mesh(cellGeometry, cellMaterial);
            cellMembrane.castShadow = true;
            eukaryoticGroup.add(cellMembrane);
            
            // 细胞核
            const nucleusGeometry = new THREE.SphereGeometry(4, 32, 32);
            const nucleusMaterial = new THREE.MeshLambertMaterial({ color: 0x1660AB });
            const nucleus = new THREE.Mesh(nucleusGeometry, nucleusMaterial);
            nucleus.castShadow = true;
            eukaryoticGroup.add(nucleus);
            
            // 线粒体
            for (let i = 0; i < 8; i++) {
                const mitoGeometry = new THREE.SphereGeometry(1, 16, 16);
                const mitoMaterial = new THREE.MeshLambertMaterial({ color: 0xA61B29 });
                const mitochondria = new THREE.Mesh(mitoGeometry, mitoMaterial);
                
                const angle = (i / 8) * Math.PI * 2;
                mitochondria.position.set(
                    Math.cos(angle) * 6,
                    (Math.random() - 0.5) * 4,
                    Math.sin(angle) * 6
                );
                mitochondria.castShadow = true;
                eukaryoticGroup.add(mitochondria);
            }
            
            eukaryoticGroup.position.set(15, 0, 0);
            scene.add(eukaryoticGroup);
            
            // 添加标签
            const label = createTextLabel('真核细胞 (备用)', new THREE.Vector3(15, 15, 0));
            scene.add(label);
        }
        
        // 创建文字标签
        function createTextLabel(text, position) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 300;
            canvas.height = 80;
            
            // 背景
            context.fillStyle = 'rgba(249, 242, 224, 0.95)';
            context.roundRect(0, 0, 300, 80, 10);
            context.fill();
            
            // 边框
            context.strokeStyle = 'rgba(9, 55, 92, 0.3)';
            context.lineWidth = 2;
            context.stroke();
            
            // 文字
            context.fillStyle = '#2B313F';
            context.font = 'bold 20px Arial';
            context.textAlign = 'center';
            context.fillText(text, 150, 50);
            
            const texture = new THREE.CanvasTexture(canvas);
            const material = new THREE.SpriteMaterial({ map: texture });
            const sprite = new THREE.Sprite(material);
            sprite.position.copy(position);
            sprite.scale.set(10, 2.7, 1);
            
            return sprite;
        }
        
        // 动画循环
        function animate() {
            requestAnimationFrame(animate);
            
            // 更新控制器
            if (controls) {
                controls.update();
            }
            
            // 渲染场景
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }
        
        // 窗口大小调整
        function handleResize() {
            if (camera && renderer) {
                const container = document.getElementById('prokaryotic-container');
                const width = container.clientWidth;
                const height = container.clientHeight;
                
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            }
        }
        
        // 事件监听器
        function setupEventListeners() {
            enterButton.addEventListener('click', enterMainApp);
            window.addEventListener('resize', handleResize);
            
            // 键盘快捷键
            document.addEventListener('keydown', function(event) {
                switch(event.code) {
                    case 'KeyR': // R键重置视角
                        if (camera && controls) {
                            camera.position.set(0, 15, 35);
                            controls.reset();
                        }
                        break;
                    case 'KeyF': // F键全屏
                        if (document.fullscreenElement) {
                            document.exitFullscreen();
                        } else {
                            document.documentElement.requestFullscreen();
                        }
                        break;
                }
            });
        }
        
        // 扩展CanvasRenderingContext2D的roundRect方法（兼容性）
        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function(x, y, width, height, radius) {
                this.beginPath();
                this.moveTo(x + radius, y);
                this.lineTo(x + width - radius, y);
                this.quadraticCurveTo(x + width, y, x + width, y + radius);
                this.lineTo(x + width, y + height - radius);
                this.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
                this.lineTo(x + radius, y + height);
                this.quadraticCurveTo(x, y + height, x, y + height - radius);
                this.lineTo(x, y + radius);
                this.quadraticCurveTo(x, y, x + radius, y);
                this.closePath();
            };
        }
        
        // 控制面板功能实现
        function resetCamera() {
            console.log('📷 重置相机视角');
            if (camera && controls) {
                camera.position.set(0, 15, 35);
                controls.reset();
            }
        }
        
        function toggleFullscreen() {
            console.log('🖥️ 切换全屏模式');
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                document.documentElement.requestFullscreen();
            }
        }
        
        function highlightPart(cellType, partName) {
            console.log(`🎯 高亮${cellType}细胞的${partName}`);
            // 这里可以实现具体的高亮逻辑
            // 目前只是UI反馈
            event.target.classList.toggle('active');
        }
        
        function clearHighlight() {
            console.log('🧹 清除所有高亮');
            const buttons = document.querySelectorAll('.highlight-btn.active');
            buttons.forEach(btn => btn.classList.remove('active'));
        }
        
        function highlightEukaryoticPart(partName) {
            console.log(`🎯 尝试高亮真核细胞的${partName}`);
            
            if (window.humanAPI && biodigitalLoaded) {
                try {
                    // 使用基本的Viewer API功能
                    // 注意：由于只有Viewer API权限，高亮功能可能有限
                    const commands = {
                        'nucleus': () => {
                            window.humanAPI.send("camera.set", {
                                position: { x: 0, y: 0, z: -50 },
                                target: { x: 0, y: 0, z: 0 },
                                animate: true
                            });
                        },
                        'mitochondria': () => {
                            window.humanAPI.send("camera.set", {
                                position: { x: 25, y: 25, z: -25 },
                                target: { x: 0, y: 0, z: 0 },
                                animate: true
                            });
                        },
                        'er': () => {
                            window.humanAPI.send("camera.set", {
                                position: { x: -25, y: 0, z: -25 },
                                target: { x: 0, y: 0, z: 0 },
                                animate: true
                            });
                        },
                        'golgi': () => {
                            window.humanAPI.send("camera.set", {
                                position: { x: 0, y: 25, z: -25 },
                                target: { x: 0, y: 0, z: 0 },
                                animate: true
                            });
                        }
                    };
                    
                    if (commands[partName]) {
                        commands[partName]();
                        updateStatus('eukaryotic', 'success', `聚焦: ${partName}`);
                    } else {
                        updateStatus('eukaryotic', 'loading', '功能有限');
                    }
                    
                } catch (e) {
                    console.log('⚠️ BioDigital操作失败:', e);
                    updateStatus('eukaryotic', 'error', '操作失败');
                }
            } else {
                updateStatus('eukaryotic', 'error', 'BioDigital未加载');
            }
            
            event.target.classList.toggle('active');
        }
        
        function clearEukaryoticHighlight() {
            console.log('🔄 重置真核细胞视图');
            if (window.humanAPI && biodigitalLoaded) {
                try {
                    window.humanAPI.send("camera.reset");
                    updateStatus('eukaryotic', 'success', '视图已重置');
                } catch (e) {
                    console.log('⚠️ BioDigital重置失败:', e);
                }
            }
            const buttons = document.querySelectorAll('.highlight-btn.active');
            buttons.forEach(btn => btn.classList.remove('active'));
        }
        
        function toggleAnimation(cellType) {
            console.log(`🎬 切换${cellType}细胞动画`);
            const checkbox = document.getElementById(`${cellType}-animation`);
            // 这里可以实现具体的动画切换逻辑
        }
        
        function testBioDigitalAPI() {
            console.log('🧪 测试BioDigital Viewer API');
            if (window.humanAPI && biodigitalLoaded) {
                updateStatus('eukaryotic', 'loading', '测试API...');
                try {
                    // 测试基本的Viewer API功能
                    window.humanAPI.send("camera.info", function(data) {
                        console.log('📹 相机信息:', data);
                        updateStatus('eukaryotic', 'success', 'Viewer API正常');
                        
                        // 显示简单的API信息
                        setTimeout(() => {
                            alert(`BioDigital Viewer API测试成功！\n相机位置: ${JSON.stringify(data.position || {})}\n模型已加载且可交互`);
                        }, 500);
                    });
                    
                } catch (e) {
                    console.error('❌ API测试失败:', e);
                    updateStatus('eukaryotic', 'error', 'API测试失败');
                }
            } else {
                updateStatus('eukaryotic', 'error', 'BioDigital未加载');
                console.log('❌ BioDigital未加载或API不可用');
            }
        }
        
        function resetBioDigitalView() {
            console.log('🔄 重置BioDigital视图');
            if (window.humanAPI && biodigitalLoaded) {
                try {
                    window.humanAPI.send("camera.reset");
                    updateStatus('eukaryotic', 'success', '视图已重置');
                } catch (e) {
                    console.log('⚠️ BioDigital重置失败:', e);
                    updateStatus('eukaryotic', 'error', '重置失败');
                }
            } else {
                updateStatus('eukaryotic', 'error', 'BioDigital未加载');
            }
        }
        
        function showModelInfo() {
            console.log('📊 显示模型信息');
            if (window.humanAPI && biodigitalLoaded) {
                window.humanAPI.send("camera.info", function(data) {
                    const info = `BioDigital真核细胞模型
                    
🎯 API类型: Viewer API
📹 相机位置: (${data.position?.x || 0}, ${data.position?.y || 0}, ${data.position?.z || 0})
🔑 API Key: ${BIODIGITAL_API_KEY.substring(0, 8)}...
✅ 状态: 已加载并可交互

📝 说明: 使用BioDigital专业医学3D模型展示真核细胞结构`;
                    alert(info);
                });
            } else {
                alert('BioDigital模型未加载或API不可用');
            }
        }
        
        // 初始化应用
        function init() {
            console.log('🎬 初始化细胞结构3D可视化平台');
            
            // 设置构建时间
            const buildTimeElement = document.getElementById('build-time');
            if (buildTimeElement) {
                buildTimeElement.textContent = new Date().toLocaleString();
            }
            
            setupEventListeners();
            initVideoIntro();
        }
        
        // 页面加载完成后启动
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
        
        console.log('✅ 平台脚本初始化完成');
    </script>
</body>
</html>
